#!/bin/bash

#echo "Starting pre-commit hook..."

# Get the list of files that are staged for commit
STAGED_FILES=$(git diff --cached --name-only)

#echo "Staged files for commit:"
#echo "$STAGED_FILES"

# Loop through each staged file
for file in $STAGED_FILES; do
  #echo "Checking file: $file"
  
  # Check if the filename contains '.gpg' anywhere
  if [[ "$file" == *".gpg"* ]]; then
    #echo "File $file has a .gpg extension. Verifying if it is encrypted..."
    
    # Use the 'file' command to check if it's encrypted
    FILE_TYPE=$(file "$file")
    
    if [[ "$FILE_TYPE" == *"PGP"* ]]; then
      :
      #echo "File '$file' is properly encrypted."
    else
      echo "Error: File '$file' does not appear to be properly encrypted. File type is: $FILE_TYPE"
      exit 1
    fi
  else
    : 
    #echo "File '$file' does not have a .gpg extension. Skipping..."
  fi
done

#echo "All .gpg files are encrypted. Commit allowed."
exit 0
